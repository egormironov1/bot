scenario Main {

    # =========================
    # GLOBAL FALLBACK
    # =========================
    state: /NoMatch {
        q: * -> {
            a: "Я могу помочь с погодой и курсом валют. Напишите: погода или курс валют. Также можно /hello."
        }
    }

    # =========================
    # HELLO
    # =========================
    state: /hello {
        q: /hello -> { a: "Привет! Я бот-помощник. Могу подсказать погоду и курс валют. Напишите: погода или курс валют." }
        q: "(?i)^(привет|здравствуй|здравствуйте|добрый\\s*(день|вечер|утро)|хай|hello|hi)\\b.*" -> {
            a: "Привет! Могу рассказать про погоду и курс валют. Что интересует?"
        }
    }

    # =========================
    # WEATHER
    # =========================
    state: /weather {
        q: /weather -> { a: "Погоду для какого города подсказать? (например: Рига)" }

        # разные формулировки
        q: "(?i).*\\b(погода|прогноз|температур(а|у)|дожд(ь|и)|снег|ветер|градус(ы|ов)|что\\s+там\\s+на\\s+улице)\\b.*" -> {
            a: "Погоду для какого города подсказать? (например: Рига)"
        }

        # если пользователь сразу пишет город
        q: "(?i)^(?:погода|прогноз)\\s+(?:в|во|на)\\s+([\\p{L}\\- ]{2,})\\s*$" -> {
            a: "Я понял запрос про погоду. Уточню: вы хотите прогноз для города $1?"
        }
    }

    # =========================
    # CURRENCY
    # =========================
    state: /currency {
        q: /currency -> {
            a: "Какую валюту показать? Например: USD, EUR. Можно написать: курс доллара или курс евро."
        }

        # разные формулировки
        q: "(?i).*\\b(курс|валют(а|ы)|обмен|exchange|rate)\\b.*" -> {
            a: "Какую валюту показать? Например: USD или EUR."
        }

        # конкретика
        q: "(?i).*\\b(доллар(а|ов)?|usd)\\b.*" -> { a: "Курс USD зависит от источника. Скажите, к какой валюте показать: к RUB или к EUR?" }
        q: "(?i).*\\b(евро|eur)\\b.*" -> { a: "Курс EUR зависит от источника. Скажите, к какой валюте показать: к RUB или к USD?" }
    }

    # =========================
    # ROOT / ROUTING
    # =========================
    state: / {
        q: /start -> { go: /hello }
        q: /hello -> { go: /hello }
        q: /weather -> { go: /weather }
        q: /currency -> { go: /currency }

        # маршрутизация по словам (чтобы ловить не-слеш команды)
        q: "(?i).*\\b(привет|здравствуй|здравствуйте|добрый\\s*(день|вечер|утро)|hello|hi)\\b.*" -> { go: /hello }
        q: "(?i).*\\b(погода|прогноз|температур(а|у)|дожд(ь|и)|снег|ветер)\\b.*" -> { go: /weather }
        q: "(?i).*\\b(курс|валют(а|ы)|обмен|usd|eur|доллар|евро)\\b.*" -> { go: /currency }

        q: * -> { go: /NoMatch }
    }
}
